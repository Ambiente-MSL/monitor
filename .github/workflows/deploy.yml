name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Monitor
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        command_timeout: 30m
        script: |
          set -e

          echo "========================================="
          echo "ğŸ”„ Iniciando deploy do Monitor"
          echo "========================================="

          cd /root/monitor || exit 1

          echo "â¬‡ï¸  Fazendo sync com origin/main..."
          git fetch origin main
          git reset --hard origin/main

          echo "ğŸ“ Ãšltimo commit:"
          git log -1 --oneline

          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1

          echo "ğŸ”¨ Build + Up (sem derrubar tudo)..."
          docker compose up -d --build --remove-orphans

          echo "â³ Aguardando containers..."
          sleep 5

          echo "ğŸ“Š Status dos containers:"
          docker compose ps

          echo "ğŸ§¹ Limpeza segura (opcional)..."
          docker image prune -f --filter "until=168h"

          echo "========================================="
          echo "âœ… Deploy concluÃ­do!"
          echo "========================================="
