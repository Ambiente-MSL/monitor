name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-monitor
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Monitor
    runs-on: ubuntu-latest

    steps:
    - name: üöÄ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        command_timeout: 30m
        script: |
          set -e

          echo "========================================="
          echo "üîÑ Iniciando deploy do Monitor"
          echo "========================================="

          cd /root/monitor || exit 1

          ENV_FILE="${BACKEND_ENV_FILE:-./deploy/backend.env}"
          if [ ! -f "$ENV_FILE" ]; then
            echo "Missing backend env file: $ENV_FILE"
            exit 1
          fi
          export BACKEND_ENV_FILE="$ENV_FILE"

          echo "‚¨áÔ∏è  Fazendo sync com origin/main..."
          git fetch origin main
          git reset --hard origin/main

          echo "üìù √öltimo commit:"
          git log -1 --oneline

          export DOCKER_BUILDKIT=1
          export COMPOSE_DOCKER_CLI_BUILD=1

          echo "üî® Build + Up (sem derrubar tudo)..."
          docker compose up -d --build --remove-orphans

          echo "‚è≥ Aguardando containers..."
          sleep 5

          echo "üìä Status dos containers:"
          docker compose ps

          echo "üßπ Limpeza segura (opcional)..."
          docker image prune -f --filter "until=168h"

          echo "========================================="
          echo "‚úÖ Deploy conclu√≠do!"
          echo "========================================="
